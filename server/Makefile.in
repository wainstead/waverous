# Copyright (c) 1992, 1995, 1996 Xerox Corporation.  All rights reserved.
# Portions of this code were written by Stephen White, aka ghond.
# Use and copying of this software and preparation of derivative works based
# upon this software are permitted.  Any distribution of this software or
# derivative works must comply with all applicable United States export
# control laws.  This software is made available AS IS, and Xerox Corporation
# makes no warranty about the software, its performance or its conformity to
# any specification.

# @configure_input@

CC	= @CXX@
DEFS	= @DEFS@
LIBS	= @LIBS@
YACC	= @YACC@

# for debugging you might prefer:
# CFLAGS='-g -m32 -O0 -Wall'

CFLAGS		= -m32 -O
CPPFLAGS	= @CPPFLAGS@
INSTALL         = @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@

YFLAGS = -d
COMPILE.c = $(CC) $(CFLAGS) $(DEFS) $(CPPFLAGS) -c

CSRCS = ast.c code_gen.c db_file.c db_io.c db_objects.c db_properties.c \
	db_verbs.c decompile.c disassemble.c eval_env.c eval_vm.c \
	exceptions.c execute.c extensions.c functions.c keywords.c list.c \
	log.c match.c md5.c name_lookup.c network.c net_mplex.c \
	net_proto.c numbers.c objects.c parse_cmd.c pattern.c program.c \
	property.c quota.c ref_count.c regexpr.c server.c storage.c streams.c str_intern.c \
	sym_table.c tasks.c timers.c unparse.c utils.c verbs.c version.c \
	bg_name_lookup.c

OPT_EXT_XML_SRC = ext-xml.c
OPT_EXT_FUP_SRC = ext-FUP.c
OPT_FILEIO_SRC  = extension-fileio.c

OPT_NET_SRCS = net_single.c net_multi.c \
	net_mp_selct.c net_mp_poll.c net_mp_fake.c \
	net_tcp.c \
	net_bsd_tcp.c net_bsd_lcl.c net_sysv_tcp.c net_sysv_lcl.c

OPT_NET_OBJS = $(OPT_NET_SRCS:.c=.o)

YSRCS = parser.y

HDRS =  ast.h bf_register.h code_gen.h db.h db_io.h db_private.h decompile.h \
	db_tune.h \
	disassemble.h eval_env.h eval_vm.h exceptions.h execute.h functions.h \
	getpagesize.h keywords.h list.h log.h match.h md5.h name_lookup.h \
	network.h net_mplex.h net_multi.h net_proto.h numbers.h opcode.h \
	options.h parse_cmd.h parser.h pattern.h program.h quota.h random.h \
	ref_count.h regexpr.h server.h storage.h streams.h structures.h  str_intern.h \
	sym_table.h tasks.h timers.h tokens.h unparse.h utils.h verbs.h \
	version.h

SYSHDRS = my-ctype.h my-fcntl.h my-in.h my-inet.h my-ioctl.h my-math.h \
	my-poll.h my-signal.h my-socket.h my-stat.h my-stdarg.h my-stdio.h \
	my-stdlib.h my-string.h my-stropts.h my-sys-time.h my-time.h \
	my-tiuser.h my-types.h my-unistd.h my-wait.h

CLIENT_SRCS = client_bsd.c client_sysv.c

ALL_CSRCS = $(CSRCS) $(OPT_EXT_FUP_SRC) $(OPT_EXT_XML_SRC) $(OPT_FILEIO_SRC) $(CLIENT_SRCS)

SRCS = $(ALL_CSRCS) keywords.gperf $(YSRCS) $(HDRS) $(SYSHDRS)

COBJS = $(CSRCS:.c=.o) $(OPT_EXT_FUP_SRC:.c=.o)  $(OPT_EXT_XML_SRC:.c=.o) $(OPT_FILEIO_SRC:.c=.o)

YOBJS = $(YSRCS:.y=.o)

OBJS = $(COBJS) $(YOBJS)

moo:	$(OBJS)
	$(CC) $(CFLAGS) $(DEFS) $(OBJS) $(LIBS) -o $@

# 'purify' is a memory leak checker, now IBM Rational Purify. --sw
pure_moo: moo
	purify $(CC) $(CFLAGS) $(DEFS) $(OBJS) $(LIBS) -o $@

client_bsd: client_bsd.o
	$(CC) $(CFLAGS) $(DEFS) client_bsd.o $(LIBS) -o $@

client_sysv: client_sysv.o
	$(CC) $(CFLAGS) $(DEFS) client_sysv.o $(LIBS) -o $@

configure: configure.ac
	@echo "Not running autoconf; you must do this by hand."
	touch configure

config.status: configure
	env CC= YACC= ./configure --no-create

Makefile: Makefile.in config.status
	@echo "[ $@ : $? ]"
	./config.status

config.h: config.h.in config.status
	@echo "[ $@ : $? ]"
	./config.status

y.tab.h: parser.o
	touch y.tab.h

# The LambdaMOO server project originally shipped with a lightly
# hacked version 2.1 of GNU gperf, renamed 'pgperf'; Pavel Curtis
# added a new command line option, '-l', to make the generated hash
# table case-insensitive. In 2002, the option '--ignore-case' was
# added to GNU gperf, and by 2011 the 'pgperf' shipped with LambdaMOO
# no longer compiled due to obsolesence (it used varargs.h, which is
# no longer supported). Also, the '-a' command line flag was replaced
# by '--language' and the flag '-p' was dropped (and no explanation
# given in gperf's ChangeLog). I've expanded the short options into
# long options here for readability. For the sake of history, this was
# the original incantation:
# pgperf -aCIptT -k1,3,$$ keywords.gperf
# --sw July 2011
keywords.c: keywords.gperf
	gperf --language=C++ --ignore-case --readonly-tables --struct-type \
		--omit-struct-type --key-positions=1,3,$$ keywords.gperf   \
		| sed -e 's/#include <ctype.h>/#include "my-ctype.h"/'     \
		> keywords.c

TAGS:
	etags $(SRCS)

clean:
	rm -f $(OBJS) $(OPT_NET_OBJS) core parser.c y.tab.c y.tab.h y.output makedep eddep

distclean:	clean
	rm -f config.h Makefile config.status config.log config.cache

# You have to run "make," thus compiling the project first before you
# can run "make depend." This is because "y.tab.h" is generated by flex
# during the compilation process:
#   In file included from keywords.c:29:
#   tokens.h:23:19: error: y.tab.h: No such file or directory
# Without y.tab.h "make depend" fails with this error.

depend: ${ALL_CSRCS}
# remove the temporary files made by this target
	rm -f eddep makedep
# use gcc to figure out all dependencies in the source files
	gcc -MM ${CFLAGS} ${ALL_CSRCS} | sed -e '/:$$/d' > makedep
	echo '/^# DO NOT DELETE THIS LINE/+1,$$d' >eddep
# add the line you see in this Makefile below
	echo '$$r makedep' >>eddep
	echo 'w' >>eddep
	cp Makefile.in Makefile.in.bak
# use the line editor "ex" to transform Makefile.in
	ex - Makefile.in < eddep
	rm -f eddep makedep # remove the temporary files

all: moo

.PHONY: all clean distclean TAGS depend pure_moo


# Have to do this one manually, since make depend cannot hack yacc files.
parser.o:	my-ctype.h my-math.h my-stdlib.h my-string.h \
		ast.h code_gen.h config.h functions.h \
		keywords.h list.h log.h numbers.h opcode.h parser.h program.h \
		storage.h streams.h structures.h sym_table.h utils.h version.h

# Must do these specially, since they depend upon C preprocessor options.
network.o: 	net_single.o net_multi.o
net_proto.o:	net_bsd_tcp.o net_bsd_lcl.o net_sysv_tcp.o net_sysv_lcl.o
net_mplex.o:	net_mp_selct.o net_mp_poll.o net_mp_fake.o

$(OPT_NET_OBJS):
	touch $@

# DO NOT DELETE THIS LINE -- 'make depend' replaces everything below it.
ast.o: ast.c my-string.h config.h ast.h parser.h program.h structures.h \
  my-stdio.h version.h sym_table.h list.h log.h storage.h ref_count.h \
  utils.h execute.h db.h opcode.h options.h parse_cmd.h
code_gen.o: code_gen.c ast.h config.h parser.h program.h structures.h \
  my-stdio.h version.h sym_table.h exceptions.h opcode.h options.h \
  storage.h my-string.h ref_count.h str_intern.h utils.h execute.h db.h \
  parse_cmd.h my-stdlib.h
db_file.o: db_file.c my-stat.h config.h my-unistd.h my-stdio.h \
  my-stdlib.h db.h program.h structures.h version.h db_io.h db_private.h \
  exceptions.h list.h log.h options.h server.h network.h storage.h \
  my-string.h ref_count.h streams.h str_intern.h tasks.h execute.h \
  opcode.h parse_cmd.h timers.h my-time.h
db_io.o: db_io.c my-ctype.h config.h my-stdarg.h my-stdio.h my-stdlib.h \
  db_io.h program.h structures.h version.h db_private.h exceptions.h \
  list.h log.h numbers.h parser.h storage.h my-string.h ref_count.h \
  streams.h str_intern.h unparse.h
db_objects.o: db_objects.c config.h db.h program.h structures.h \
  my-stdio.h version.h db_private.h exceptions.h list.h storage.h \
  my-string.h ref_count.h utils.h execute.h opcode.h options.h \
  parse_cmd.h
db_properties.o: db_properties.c config.h db.h program.h structures.h \
  my-stdio.h version.h db_private.h exceptions.h list.h storage.h \
  my-string.h ref_count.h utils.h execute.h opcode.h options.h \
  parse_cmd.h
db_verbs.o: db_verbs.c my-stdlib.h config.h my-string.h db.h program.h \
  structures.h my-stdio.h version.h db_private.h exceptions.h db_tune.h \
  list.h log.h parse_cmd.h storage.h ref_count.h utils.h execute.h \
  opcode.h options.h
decompile.o: decompile.c ast.h config.h parser.h program.h structures.h \
  my-stdio.h version.h sym_table.h decompile.h exceptions.h opcode.h \
  options.h storage.h my-string.h ref_count.h utils.h execute.h db.h \
  parse_cmd.h
disassemble.o: disassemble.c my-stdio.h config.h bf_register.h db.h \
  program.h structures.h version.h functions.h execute.h opcode.h \
  options.h parse_cmd.h list.h storage.h my-string.h ref_count.h \
  streams.h unparse.h utils.h verbs.h
eval_env.o: eval_env.c config.h eval_env.h structures.h my-stdio.h \
  version.h storage.h my-string.h ref_count.h sym_table.h utils.h \
  execute.h db.h program.h opcode.h options.h parse_cmd.h
eval_vm.o: eval_vm.c config.h db_io.h program.h structures.h my-stdio.h \
  version.h decompile.h ast.h parser.h sym_table.h eval_vm.h execute.h \
  db.h opcode.h options.h parse_cmd.h log.h storage.h my-string.h \
  ref_count.h tasks.h
exceptions.o: exceptions.c exceptions.h config.h
execute.o: execute.c my-string.h config.h db.h program.h structures.h \
  my-stdio.h version.h db_io.h decompile.h ast.h parser.h sym_table.h \
  eval_env.h eval_vm.h execute.h opcode.h options.h parse_cmd.h \
  exceptions.h functions.h list.h log.h numbers.h server.h network.h \
  storage.h ref_count.h streams.h tasks.h timers.h my-time.h utils.h
extensions.o: extensions.c config.h bf_register.h functions.h my-stdio.h \
  execute.h db.h program.h structures.h version.h opcode.h options.h \
  parse_cmd.h db_tune.h my-unistd.h exceptions.h log.h net_multi.h \
  storage.h my-string.h ref_count.h tasks.h utils.h list.h numbers.h
functions.o: functions.c my-stdarg.h config.h bf_register.h db_io.h \
  program.h structures.h my-stdio.h version.h functions.h execute.h db.h \
  opcode.h options.h parse_cmd.h list.h log.h server.h network.h \
  storage.h my-string.h ref_count.h streams.h unparse.h utils.h
keywords.o: keywords.c my-ctype.h config.h my-string.h keywords.h \
  structures.h my-stdio.h version.h tokens.h ast.h parser.h program.h \
  sym_table.h y.tab.h utils.h execute.h db.h opcode.h options.h \
  parse_cmd.h
list.o: list.c my-ctype.h config.h my-string.h bf_register.h exceptions.h \
  functions.h my-stdio.h execute.h db.h program.h structures.h version.h \
  opcode.h options.h parse_cmd.h list.h log.h md5.h pattern.h random.h \
  ref_count.h streams.h storage.h unparse.h utils.h
log.o: log.c my-stdarg.h config.h my-stdio.h my-string.h my-time.h \
  bf_register.h functions.h execute.h db.h program.h structures.h \
  version.h opcode.h options.h parse_cmd.h log.h storage.h ref_count.h \
  streams.h utils.h
match.o: match.c my-stdlib.h config.h my-string.h db.h program.h \
  structures.h my-stdio.h version.h exceptions.h match.h parse_cmd.h \
  storage.h ref_count.h unparse.h utils.h execute.h opcode.h options.h
md5.o: md5.c my-string.h config.h md5.h
name_lookup.o: name_lookup.c options.h config.h my-signal.h my-stdlib.h \
  my-unistd.h my-inet.h my-in.h my-types.h my-socket.h my-wait.h \
  my-string.h log.h my-stdio.h structures.h server.h network.h storage.h \
  ref_count.h timers.h my-time.h
network.o: network.c options.h config.h net_multi.c my-ctype.h my-fcntl.h \
  my-ioctl.h my-signal.h my-stdio.h my-stdlib.h my-string.h my-unistd.h \
  exceptions.h list.h structures.h log.h net_mplex.h net_multi.h \
  net_proto.h network.h server.h streams.h storage.h ref_count.h timers.h \
  my-time.h utils.h execute.h db.h program.h version.h opcode.h \
  parse_cmd.h
net_mplex.o: net_mplex.c options.h config.h net_mp_selct.c my-string.h \
  my-sys-time.h my-types.h log.h my-stdio.h structures.h net_mplex.h
net_proto.o: net_proto.c options.h config.h net_bsd_tcp.c my-inet.h \
  my-in.h my-types.h my-socket.h my-stdlib.h my-string.h my-unistd.h \
  list.h structures.h my-stdio.h log.h name_lookup.h net_proto.h server.h \
  network.h streams.h timers.h my-time.h utils.h execute.h db.h program.h \
  version.h opcode.h parse_cmd.h net_tcp.c exceptions.h
numbers.o: numbers.c my-math.h my-stdlib.h config.h my-string.h my-time.h \
  functions.h my-stdio.h execute.h db.h program.h structures.h version.h \
  opcode.h options.h parse_cmd.h log.h random.h storage.h ref_count.h \
  utils.h
objects.o: objects.c db.h config.h program.h structures.h my-stdio.h \
  version.h db_io.h exceptions.h execute.h opcode.h options.h parse_cmd.h \
  functions.h list.h numbers.h quota.h server.h network.h storage.h \
  my-string.h ref_count.h utils.h
parse_cmd.o: parse_cmd.c my-ctype.h config.h my-stdio.h my-stdlib.h \
  my-string.h my-time.h db.h program.h structures.h version.h list.h \
  match.h parse_cmd.h storage.h ref_count.h utils.h execute.h opcode.h \
  options.h
pattern.o: pattern.c my-ctype.h config.h my-stdlib.h my-string.h \
  pattern.h regexpr.h storage.h structures.h my-stdio.h ref_count.h \
  streams.h
program.o: program.c ast.h config.h parser.h program.h structures.h \
  my-stdio.h version.h sym_table.h exceptions.h list.h storage.h \
  my-string.h ref_count.h utils.h execute.h db.h opcode.h options.h \
  parse_cmd.h
property.o: property.c db.h config.h program.h structures.h my-stdio.h \
  version.h functions.h execute.h opcode.h options.h parse_cmd.h list.h \
  storage.h my-string.h ref_count.h utils.h
quota.o: quota.c config.h db.h program.h structures.h my-stdio.h \
  version.h quota.h
ref_count.o: ref_count.c config.h exceptions.h ref_count.h storage.h \
  my-string.h structures.h my-stdio.h
regexpr.o: regexpr.c my-stdio.h config.h regexpr.h my-stdlib.h \
  my-string.h
server.o: server.c my-types.h config.h my-signal.h my-stdarg.h my-stdio.h \
  my-stdlib.h my-string.h my-unistd.h my-wait.h db.h program.h \
  structures.h version.h db_io.h disassemble.h execute.h opcode.h \
  options.h parse_cmd.h functions.h list.h log.h network.h server.h \
  parser.h random.h storage.h ref_count.h streams.h tasks.h timers.h \
  my-time.h unparse.h utils.h
storage.o: storage.c my-stdlib.h config.h exceptions.h list.h \
  structures.h my-stdio.h options.h ref_count.h storage.h my-string.h \
  utils.h execute.h db.h program.h version.h opcode.h parse_cmd.h
streams.o: streams.c my-stdarg.h config.h my-string.h my-stdio.h log.h \
  structures.h storage.h ref_count.h streams.h
str_intern.o: str_intern.c my-stdlib.h config.h log.h my-stdio.h \
  structures.h storage.h my-string.h ref_count.h str_intern.h utils.h \
  execute.h db.h program.h version.h opcode.h options.h parse_cmd.h
sym_table.o: sym_table.c my-stdio.h config.h ast.h parser.h program.h \
  structures.h version.h sym_table.h exceptions.h log.h storage.h \
  my-string.h ref_count.h utils.h execute.h db.h opcode.h options.h \
  parse_cmd.h
tasks.o: tasks.c my-string.h config.h my-time.h db.h program.h \
  structures.h my-stdio.h version.h db_io.h decompile.h ast.h parser.h \
  sym_table.h eval_env.h eval_vm.h execute.h opcode.h options.h \
  parse_cmd.h exceptions.h functions.h list.h log.h match.h numbers.h \
  random.h server.h network.h storage.h ref_count.h streams.h tasks.h \
  utils.h verbs.h
timers.o: timers.c my-signal.h config.h my-stdlib.h my-sys-time.h \
  options.h my-types.h my-time.h my-unistd.h timers.h
unparse.o: unparse.c my-ctype.h config.h my-stdio.h ast.h parser.h \
  program.h structures.h version.h sym_table.h decompile.h exceptions.h \
  functions.h execute.h db.h opcode.h options.h parse_cmd.h keywords.h \
  list.h log.h unparse.h storage.h my-string.h ref_count.h streams.h \
  utils.h
utils.o: utils.c my-ctype.h config.h my-stdio.h my-string.h db.h \
  program.h structures.h version.h db_io.h exceptions.h list.h log.h \
  match.h numbers.h ref_count.h server.h network.h options.h storage.h \
  streams.h utils.h execute.h opcode.h parse_cmd.h
verbs.o: verbs.c my-string.h config.h db.h program.h structures.h \
  my-stdio.h version.h exceptions.h execute.h opcode.h options.h \
  parse_cmd.h functions.h list.h log.h match.h parser.h server.h \
  network.h storage.h ref_count.h unparse.h utils.h verbs.h
version.o: version.c config.h version.h
bg_name_lookup.o: bg_name_lookup.c tasks.h config.h execute.h db.h \
  program.h structures.h my-stdio.h version.h opcode.h options.h \
  parse_cmd.h functions.h utils.h list.h my-in.h my-types.h log.h \
  exceptions.h net_multi.h storage.h my-string.h ref_count.h server.h \
  network.h
ext-FUP.o: ext-FUP.c config.h
ext-xml.o: ext-xml.c config.h bf_register.h functions.h my-stdio.h \
  execute.h db.h program.h structures.h version.h opcode.h options.h \
  parse_cmd.h db_tune.h storage.h my-string.h ref_count.h list.h \
  streams.h utils.h exceptions.h tasks.h
extension-fileio.o: extension-fileio.c
client_bsd.o: client_bsd.c my-socket.h config.h my-stdio.h my-stdlib.h \
  my-string.h my-sys-time.h options.h my-types.h my-unistd.h
client_sysv.o: client_sysv.c my-fcntl.h config.h my-signal.h my-stdio.h \
  my-stdlib.h my-string.h my-types.h my-stat.h my-unistd.h options.h
